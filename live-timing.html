<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GachaRun Auto-Timing System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* Terminator HUD Style */
        body { background-color: #000; color: #0f0; font-family: 'Courier New', monospace; overflow: hidden; }
        
        .scanner-box {
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6); /* Gelapkan area luar kotak */
        }
        
        .corner {
            position: absolute; width: 20px; height: 20px; border-color: #00ff00; border-style: solid; transition: all 0.2s;
        }
        
        /* Animasi saat mendeteksi angka */
        .detected .corner { border-color: #ffff00; box-shadow: 0 0 15px #ffff00; }
        .detected .scan-laser { background: #ffff00; box-shadow: 0 0 10px #ffff00; }

        .scan-laser {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: #00ff00; box-shadow: 0 0 10px #00ff00;
            animation: scanning 1.5s infinite linear;
        }
        
        @keyframes scanning {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
    </style>
</head>
<body>

<div id="app" class="h-screen w-full relative flex flex-col">

    <video ref="videoRef" autoplay playsinline muted class="absolute inset-0 w-full h-full object-cover z-0"></video>
    <canvas ref="canvasRef" class="hidden"></canvas> <div class="relative z-10 flex flex-col h-full justify-between pointer-events-none">
        
        <div class="bg-black/80 p-4 flex justify-between items-center pointer-events-auto backdrop-blur-sm border-b border-green-900">
            <div>
                <h1 class="text-green-500 font-bold text-lg tracking-tighter">OCR-TIMING <span class="text-xs bg-green-900 px-1 rounded text-green-200">AUTO v5</span></h1>
                <div class="text-gray-400 text-xs font-mono mt-1">{{ statusText }}</div>
            </div>
            <div class="text-right">
                <div class="text-2xl font-bold text-white font-mono">{{ currentTime }}</div>
                <button @click="toggleScanning" class="mt-1 px-3 py-1 rounded text-xs font-bold border" :class="isScanning ? 'bg-green-600 text-white border-green-500' : 'bg-red-900 text-red-300 border-red-700'">
                    {{ isScanning ? 'SCANNING ACTIVE' : 'PAUSED' }}
                </button>
            </div>
        </div>

        <div class="flex-1 flex items-center justify-center">
            <div class="relative w-72 h-40 scanner-box rounded-lg flex items-center justify-center transition-all duration-200" :class="lastConfidence > 80 ? 'detected' : ''">
                <div class="corner border-t-4 border-l-4 -top-1 -left-1 rounded-tl-lg"></div>
                <div class="corner border-t-4 border-r-4 -top-1 -right-1 rounded-tr-lg"></div>
                <div class="corner border-b-4 border-l-4 -bottom-1 -left-1 rounded-bl-lg"></div>
                <div class="corner border-b-4 border-r-4 -bottom-1 -right-1 rounded-br-lg"></div>
                
                <div v-if="isScanning" class="scan-laser"></div>

                <div class="bg-black/60 px-2 py-1 rounded text-center">
                    <div v-if="processingFrame" class="text-[10px] text-yellow-300 animate-pulse">PROCESSING...</div>
                    <div v-else class="text-2xl font-bold font-mono text-white tracking-widest drop-shadow-md">
                        {{ liveRead ? liveRead : '...' }}
                    </div>
                    <div v-if="lastConfidence > 0" class="text-[10px] mt-1" :class="lastConfidence > 80 ? 'text-green-400' : 'text-red-400'">
                        CONFIDENCE: {{ Math.round(lastConfidence) }}%
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-black/90 p-4 h-1/3 overflow-y-auto pointer-events-auto border-t border-green-900">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xs text-gray-500 font-bold uppercase">Recorded Times</h3>
                <span class="text-xs text-green-600">{{ logs.length }} Entries</span>
            </div>
            <div class="space-y-1 font-mono text-sm">
                <div v-for="(log, i) in logs" :key="i" class="flex justify-between p-2 rounded border-l-4" :class="i===0 ? 'bg-green-900/40 border-green-400 animate-pulse' : 'bg-gray-900 border-gray-700'">
                    <span class="font-bold text-white text-lg">#{{ log.bib }}</span>
                    <div class="text-right">
                        <div class="text-green-400">{{ log.time }}</div>
                        <div class="text-[10px] text-gray-500">Conf: {{ Math.round(log.conf) }}%</div>
                    </div>
                </div>
                <div v-if="logs.length === 0" class="text-center text-gray-600 py-4 italic">Belum ada pelari terdeteksi...</div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted, onUnmounted } = Vue;

    createApp({
        setup() {
            // -- State --
            const videoRef = ref(null);
            const canvasRef = ref(null);
            const statusText = ref('Initializing Tesseract...');
            const isScanning = ref(false);
            const processingFrame = ref(false); // The "Lock" mechanism
            const liveRead = ref('');
            const lastConfidence = ref(0);
            const currentTime = ref('');
            const logs = ref([]);
            
            // Tesseract Worker Instance
            let worker = null;
            let scanInterval = null;

            // Validasi BIB (Hanya terima angka 3-4 digit)
            const isValidBib = (text) => {
                const clean = text.replace(/[^0-9]/g, '');
                return clean.length >= 3 && clean.length <= 4;
            };

            // -- 1. Setup Tesseract Worker (Sesuai Konsep Artikel) --
            const initTesseract = async () => {
                try {
                    statusText.value = 'Loading AI Model...';
                    
                    // Create Worker (v5 syntax)
                    worker = await Tesseract.createWorker('eng', 1, {
                        logger: m => console.log(m) // Optional logging
                    });
                    
                    // Set Parameters: Allowlist hanya ANGKA
                    await worker.setParameters({
                        tessedit_char_whitelist: '0123456789',
                    });

                    statusText.value = 'AI Ready. Starting Camera...';
                    startCamera();
                } catch (err) {
                    console.error(err);
                    statusText.value = 'Error loading AI. Check console.';
                }
            };

            // -- 2. Camera Setup --
            const startCamera = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } 
                    });
                    videoRef.value.srcObject = stream;
                    videoRef.value.onloadedmetadata = () => {
                        videoRef.value.play();
                        statusText.value = 'System Online. Ready to Scan.';
                        isScanning.value = true; // Auto start
                        startScanningLoop();
                    };
                } catch (err) {
                    alert("Camera Error: Pastikan akses diizinkan & HTTPS.");
                }
            };

            // -- 3. Image Pre-processing (Wajib untuk Akurasi) --
            // Mengubah frame menjadi High Contrast Black & White
            const preprocessFrame = (ctx, width, height) => {
                const imgData = ctx.getImageData(0, 0, width, height);
                const d = imgData.data;
                for (let i = 0; i < d.length; i += 4) {
                    // Grayscale
                    const r = d[i], g = d[i+1], b = d[i+2];
                    const v = 0.2126*r + 0.7152*g + 0.0722*b;
                    // Binarization (Thresholding)
                    const t = v > 100 ? 255 : 0; // Jika terang jadi putih, gelap jadi hitam
                    d[i] = d[i+1] = d[i+2] = t;
                }
                ctx.putImageData(imgData, 0, 0);
            };

            // -- 4. The Loop Logic (Adaptasi dari Artikel) --
            const startScanningLoop = () => {
                // Jalankan setiap 200ms (5 FPS) agar HP tidak overheat
                // Realtime video 30fps tidak perlu di-scan semua.
                scanInterval = setInterval(async () => {
                    if (!isScanning.value || !worker || processingFrame.value) return;

                    processFrame();
                }, 250); 
            };

            const processFrame = async () => {
                processingFrame.value = true; // LOCK: Jangan proses frame lain dulu

                const video = videoRef.value;
                const canvas = canvasRef.value;
                const ctx = canvas.getContext('2d');

                // Define ROI (Region of Interest) - Hanya scan kotak tengah
                // Ini mempercepat proses 5x lipat dibanding scan full layar
                const vidW = video.videoWidth;
                const vidH = video.videoHeight;
                
                // Ukuran kotak scan (relatif terhadap video)
                const cropW = vidW * 0.5; // 50% lebar
                const cropH = vidH * 0.25; // 25% tinggi
                const cropX = (vidW - cropW) / 2;
                const cropY = (vidH - cropH) / 2;

                canvas.width = cropW;
                canvas.height = cropH;

                // 1. Draw frame ke canvas
                ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);
                
                // 2. Preprocess (B&W)
                preprocessFrame(ctx, cropW, cropH);

                // 3. Recognize
                try {
                    const { data } = await worker.recognize(canvas);
                    
                    const textRaw = data.text.trim().replace(/\s/g, '');
                    const confidence = data.confidence;

                    liveRead.value = textRaw;
                    lastConfidence.value = confidence;

                    // 4. Logic Validasi & Debounce
                    if (isValidBib(textRaw) && confidence > 75) {
                        recordBib(textRaw, confidence);
                    }

                } catch (e) {
                    console.error("OCR Error", e);
                } finally {
                    processingFrame.value = false; // UNLOCK
                }
            };

            const recordBib = (bib, conf) => {
                // Cek Duplikat Terakhir (Mencegah double record dalam 10 detik)
                const lastLog = logs.value[0];
                if (lastLog && lastLog.bib === bib) {
                    const timeDiff = new Date() - lastLog.timestamp;
                    if (timeDiff < 10000) return; // Skip
                }

                // Masukkan ke Logs
                logs.value.unshift({
                    bib: bib,
                    time: new Date().toLocaleTimeString(),
                    conf: conf,
                    timestamp: new Date()
                });

                // Visual Feedback (Sound beep bisa ditambahkan disini)
                statusText.value = `Captured BIB ${bib}!`;
                setTimeout(() => statusText.value = 'Scanning...', 1500);
            };

            const toggleScanning = () => {
                isScanning.value = !isScanning.value;
            };

            // Clock Utility
            setInterval(() => {
                currentTime.value = new Date().toLocaleTimeString('id-ID', { hour12: false });
            }, 1000);

            // Lifecycle
            onMounted(() => {
                initTesseract();
            });

            onUnmounted(() => {
                if (worker) worker.terminate();
                if (scanInterval) clearInterval(scanInterval);
            });

            return {
                videoRef, canvasRef, statusText, isScanning, 
                processingFrame, liveRead, lastConfidence, logs, currentTime,
                toggleScanning
            };
        }
    }).mount('#app');
</script>
</body>
</html>